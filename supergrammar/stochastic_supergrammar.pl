:-module(stochastic_supergrammar, []).

:-add_import_module(stochastic_supergrammar, supergrammar, start).

%!	initial_probability(?P) is det.
%
%      Starting probability of a new production.
initial_probability(0).


generate_stochastic(_Rule_complexity,_Derivation_length,_Inference_limit,_Options):-
	clear_productions
	% take the next example
	,configuration:example_string(Example)
	% create a new rule
	% set its probability to 0
	,empty_production(Production, Probability)
	% take the next token (terminal or nonterminal)
	% augment the new rule
	,augmented_production(Production, Probability, Example, _Augmented)
	% calculate its probability
	% compare the two probabilities
	% Choose a rule (new or old)
	% repeat from augment step
	% prune the examples
	% repeat from the top
	% exit if there are no more examples.
	.


%!	empty_production(-Production, -Probability) is det.
%
%	Production is a new, empty production with the default initial
%	Probability.
%
%	Productions generated by empty_production/2 are in the form of
%	DCG rules with a push-back list for probabilities.
%
empty_production(P, R):-
	once(rule_name(N))
	,initial_probability(R)
	,dcg_translate_rule((N, [R] --> []), P).



%!	augmented_production(+Rule:Probability,+Example,Augmented:Probability) is nondet.
%
%	Augment the rule with a single terminal or nonterminal (the
%	termial is a token from the given Example)
augmented_production(Production, _Probability, _, New_production):-
	phrase(language, [Token])
	,augmented_production(Production,Token, New_production).
augmented_production(Production, _Probability, Example, New_production):-
	member(Token, Example)
	,augmented_production(Production, Token, New_production).


%!	augmented_production(+Production,+Token,-New_production) is nondet.
%
%	Business end of augmented_production/4. Inserts the given token
%	to the right end of the body of the given Production rule,
%	producting a New_production.
augmented_production((H:-true), Token, Production):-
	dcg_translate_rule((H --> [Token]), Production).
augmented_production((H:-T), Token, Production):-
	is_list(T) % The rule is a nonterminal.
	,T =.. [Name|Args]
	,reverse([Token|Args], New) % Place new token on right end
	,Tt =.. [Name|New]
	,dcg_translate_rule((H --> Tt), Production).



